<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Dynamic Portfolio | Projects</title>
    <meta
      name="description"
      content="Explore my projects, showcasing dynamic solutions and innovative code implementations."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Link to your external stylesheet -->
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar" role="banner">
      <div class="nav-content">
        <div class="logo">MyPortfolio</div>
        <nav class="menu" role="navigation">
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="projects.html" class="active">Projects</a>
          <a href="contact.html">Contact</a>
          <a href="modal.html">Modal</a>
        </nav>
        <div class="theme-controls">
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              aria-label="Toggle dark mode"
            />
            <span class="slider round"></span>
          </label>
          <button id="autoModeToggle" class="auto-switch">Auto</button>
        </div>
      </div>
    </header>

    <!-- Projects Section -->
    <section class="page-section projects-section">
      <h2>My Projects</h2>
      <div style="margin-bottom: 1rem; text-align: center">
        <label for="sortSelect">Sort By:</label>
        <select id="sortSelect" onchange="sortProjects()">
          <option value="date">Date (Newest First)</option>
          <option value="title">Title (A-Z)</option>
        </select>
      </div>
      <div id="projectCardsContainer" class="project-cards-container">
        <!-- Project cards get loaded here dynamically -->
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
      <p>© 2025 MyDynamicPortfolio. All Rights Reserved.</p>
    </footer>

    <!-- Modal for Project Details -->
    <div id="projectModal" class="modal">
      <div class="modal-content">
        <button class="close-btn" id="modalCloseBtn">×</button>
        <div class="detailed-view">
          <h3>Introduction</h3>
          <p id="modalIntroduction"></p>

          <h3>Methodology</h3>
          <div id="modalMethodology"></div>

          <h3>Technologies</h3>
          <ul id="modalTechnologies"></ul>

          <h3>Study Background</h3>
          <p id="modalStory"></p>

          <h3>Collected Data</h3>
          <p id="modalCollectedData"></p>

          <h3>Conclusion</h3>
          <p id="modalConclusions"></p>

          <h3>Additional Resources</h3>
          <ul id="modalResources"></ul>
        </div>
      </div>
    </div>

    <!-- Image Viewer Overlay (optional) -->
    <div id="imageViewer" class="overlay">
      <div class="overlay-content">
        <button class="close-btn" id="imageViewerCloseBtn">×</button>
        <img id="viewerImage" src="" alt="Resource Image" />
      </div>
    </div>

    <!-- Inline JavaScript for Project Loading & Sorting -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadProjects();
      });

      async function loadProjects() {
        try {
          const response = await fetch("assets/projects.json");
          if (!response.ok) throw new Error("Network response was not ok");
          const projects = await response.json();

          // Filter to ensure unique projects (in case of duplicates by ID)
          const uniqueProjects = projects.filter(
            (p, i, arr) => i === arr.findIndex((t) => t.id === p.id)
          );

          // Sort by date descending by default
          uniqueProjects.sort((a, b) => new Date(b.date) - new Date(a.date));

          // Render the project cards
          renderProjectCards(uniqueProjects);

          // Store globally for sorting
          window.projectData = uniqueProjects;

          // If a hash is present (e.g., #5), auto-open that project
          const hash = window.location.hash.substring(1);
          if (hash) {
            const projectId = parseInt(hash, 10);
            const target = uniqueProjects.find((p) => p.id === projectId);
            if (target) openModal(target);
          }
        } catch (error) {
          console.error("Error loading projects:", error);
          document.getElementById("projectCardsContainer").innerHTML =
            "<p>Unable to load projects at this time.</p>";
        }
      }

      function renderProjectCards(projects) {
        const container = document.getElementById("projectCardsContainer");
        if (!container) return;
        container.innerHTML = "";

        projects.forEach((project) => {
          const card = document.createElement("div");
          card.className = "project-card";
          card.id = `project-${project.id}`;

          // Truncate description to ~100 chars
          const shortDesc = (project.description || "No description available.")
            .replace(/(<([^>]+)>)/gi, "") // Remove HTML tags for safe substring
            .substring(0, 100);

          card.innerHTML = `
          <img
            src="${project.thumbnail || "assets/images/default.png"}"
            alt="${project.title} Thumbnail"
            class="thumbnail"
          />
          <div class="card-content">
            <h3>${project.title}</h3>
            <p><strong>Date:</strong> ${project.date}</p>
            <p>${shortDesc}...</p>
          </div>
        `;

          // When clicked, open the modal
          card.addEventListener("click", () => openModal(project));
          container.appendChild(card);
        });
      }

      function openModal(project) {
        // Populate modal fields
        document.getElementById(
          "modalIntroduction"
        ).innerHTML = `This project, "${
          project.title
        }", utilizes ${project.technologies.join(", ")}.`;
        document.getElementById("modalMethodology").innerHTML =
          project.methodology || "No methodology provided.";

        if (project.technologies && project.technologies.length) {
          document.getElementById("modalTechnologies").innerHTML =
            project.technologies.map((tech) => `<li>${tech}</li>`).join("");
        } else {
          document.getElementById("modalTechnologies").innerHTML =
            "<li>No technologies listed</li>";
        }

        document.getElementById("modalStory").innerHTML =
          project.overview?.story || "No background provided.";
        document.getElementById("modalCollectedData").innerHTML =
          project.overview?.collectedData || "No data collected.";
        document.getElementById("modalConclusions").innerHTML =
          project.overview?.conclusions || "No conclusions provided.";

        // Additional resources
        if (project.resources && project.resources.length) {
          document.getElementById("modalResources").innerHTML =
            project.resources
              .map(
                (resource) => `
    <li>
        <strong>${resource.name}</strong> (${resource.category}) – 
        <a href="https://raw.githubusercontent.com/yourusername/yourrepo/main/${resource.file_path}" target="_blank">View</a> / 
        <a href="${resource.file_path}" download>Download</a>
    </li>
`
              )
              .join("");
        } else {
          document.getElementById("modalResources").innerHTML =
            "<li>No additional resources available.</li>";
        }

        // Show the modal
        document.getElementById("projectModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("projectModal").style.display = "none";
      }

      document
        .getElementById("modalCloseBtn")
        ?.addEventListener("click", closeModal);
      window.addEventListener("click", (e) => {
        const modal = document.getElementById("projectModal");
        if (e.target === modal) closeModal();
      });

      function openImageViewer(imageUrl) {
        const overlay = document.getElementById("imageViewer");
        const viewerImage = document.getElementById("viewerImage");
        if (overlay && viewerImage) {
          viewerImage.src = imageUrl;
          overlay.style.display = "flex";
        }
      }

      function closeImageViewer() {
        const overlay = document.getElementById("imageViewer");
        if (overlay) overlay.style.display = "none";
      }

      document
        .getElementById("imageViewerCloseBtn")
        ?.addEventListener("click", closeImageViewer);
      window.addEventListener("click", (e) => {
        const overlay = document.getElementById("imageViewer");
        if (e.target === overlay) closeImageViewer();
      });

      function sortProjects() {
        const sortSelect = document.getElementById("sortSelect");
        const sortValue = sortSelect.value;
        let sortedProjects = [...(window.projectData || [])];

        if (sortedProjects.length === 0) {
          console.warn("No project data to sort.");
          return;
        }

        if (sortValue === "date") {
          sortedProjects.sort((a, b) => new Date(b.date) - new Date(a.date));
        } else if (sortValue === "title") {
          sortedProjects.sort((a, b) => a.title.localeCompare(b.title));
        }

        renderProjectCards(sortedProjects);
      }

      // Expose for inline usage in HTML
      window.sortProjects = sortProjects;
    </script>

    <!-- External Dark Mode & Auto Mode Logic -->
    <script src="assets/script.js"></script>
  </body>
</html>
